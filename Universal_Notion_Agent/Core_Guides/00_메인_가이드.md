# 🤖 Notion 페이지 작성 메인 가이드 (범용 AI 에이전트용)

> 💡 **범용 가이드**: 모든 MCP 지원 AI 플랫폼에서 사용 가능

## 📋 TL;DR (핵심 요약)

**목표**: 마크다운 파일(`.md`)을 Notion 페이지로 자동 업로드

**지원 플랫폼**: Cursor, Claude, Antigravity 및 MCP 지원 AI 플랫폼

**실행 순서**:

1. **셋업 확인** → [[#셋업-확인-체크리스트]]
2. **사용자 프롬프트 확인** → 애매하면 재질문
3. **파일 읽기** → [[#파일-읽기]]
4. **페이지 생성** → [[#페이지-생성-전략]]
5. **내용 업로드** → [[#내용-업로드]]
6. **검증 및 완료 보고** → [[#완료-보고]]

**핵심 규칙**:

- 페이지 제목: 파일명에서 `.md` 제거, `_` → 공백 변환
- ❌ **제목에 `/page` 같은 명령어 포함 금지**
- API 실패 시 **즉시 브라우저 자동화로 전환**
- 모든 단계에서 사용자에게 진행 상황 보고
- ⚠️ **기존 페이지 내용 보존 (절대 규칙)**

**참조 파일**:

- 실행 절차: `01_실행_가이드.md`
- 코드 패턴: `02_코드_패턴.md`
- 에러 처리: `03_에러_처리.md`
- 템플릿: `04_템플릿.md`

---

## 🚀 시작하기 (사용자용)

### 방법 1: 자동 셋업 확인 및 시작 (권장)

**처음 사용하거나 셋업 확인이 필요한 경우**:

```
@Universal_Notion_Agent/ 시작
```

AI Agent가 자동으로:

1. ✅ 현재 환경 및 플랫폼 감지
2. ✅ MCP 서버 연결 상태 확인
3. ✅ Notion 로그인 상태 확인
4. ✅ 미완료 셋업 안내 또는 준비 완료 보고
5. ✅ 사용 예시 프롬프트 제공

**→ 자세한 내용**: `Agent_실행_가이드.md` 참조

### 방법 2: 직접 작업 요청

**셋업이 이미 완료된 경우**, 바로 작업을 요청하세요:

```
[파일명].md 파일을 Notion에 업로드해줘
```

**더 많은 예시**: `Templates/사용자_프롬프트_템플릿.md` 참조

---

## 🎯 사용 순서 (AI Agent 실행 흐름)

### 1단계: 작업 시작 및 셋업 확인

#### 1.1 셋업 확인 체크리스트 {#셋업-확인-체크리스트}

- [ ] **MCP 서버 확인**

  - [ ] 브라우저 자동화 MCP 서버 활성화 확인
  - [ ] 도구 사용 가능 여부 확인: `browser_navigate`, `browser_evaluate`, `browser_type`, `browser_press_key`
  - [ ] **미활성화 시**: 사용자에게 MCP 서버 설정 안내

- [ ] **Notion MCP 서버 확인** (선택적, API 사용 시 필요)

  - [ ] `notion-create-pages`, `notion-move-pages` 도구 사용 가능 여부 확인
  - [ ] **없어도 작동**: 브라우저 자동화 방식 사용 가능

- [ ] **Notion 로그인 상태 확인**

  - [ ] `browser_navigate`로 `https://www.notion.so` 접속
  - [ ] 로그인 페이지로 리다이렉트되는지 확인
  - [ ] **미로그인 시**: 사용자에게 로그인 요청

- [ ] **브라우저 프로필 설정** (Google OAuth 차단 방지) ⭐
  - [ ] Chrome 기본 프로필 사용 권장 (이미 로그인된 상태)
  - [ ] 또는 전용 프로필 생성 및 사전 로그인
  - [ ] `--disable-blink-features=AutomationControlled` 플래그 설정
  - [ ] **미설정 시**: Google OAuth 로그인 차단 가능 (ERR_GOOGLE_OAUTH_BLOCKED)
  - [ ] **자세한 가이드**: `05_브라우저_프로필_설정.md` 참조

---

### 2단계: 사용자 프롬프트 확인 및 의도 파악

#### 2.1 프롬프트 분석 (Schema)

**Input Schema**:

```typescript
interface UserRequest {
  filePath: string; // 예: "README.md" 또는 "./docs/API.md"
  parentPageId?: string; // 선택적: 부모 페이지 ID (UUID 형식)
  customTitle?: string; // 선택적: 사용자 지정 제목
  action: "create" | "append"; // "create": 새 페이지, "append": 기존 페이지에 추가
}
```

**프롬프트 파싱 체크리스트**:

- [ ] **파일 경로 추출**

  - [ ] 파일명 확인 (`.md` 확장자 포함 여부)
  - [ ] 상대 경로 또는 절대 경로 확인
  - [ ] 파일 존재 여부 확인 (`read_file`로 검증)

- [ ] **부모 페이지 ID 추출** (있는 경우)

  - [ ] UUID 형식 확인
  - [ ] URL에서 ID 추출 (URL 형식인 경우)

- [ ] **사용자 지정 제목 확인**

  - [ ] "제목을 'XXX'로 해줘" 같은 표현 감지
  - [ ] 제목 미지정 시 파일명 기반 제목 생성

- [ ] **액션 타입 결정**
  - [ ] "아래에 페이지 만들어서" → `action: "create"`
  - [ ] "내용을 추가해줘" → `action: "append"`

---

### 3단계: AI Agent 작업 진행

#### 3.1 파일 읽기 {#파일-읽기}

**Input**: 파일 경로 (string)  
**Output**: 파일 내용, 라인 수, 청크 전략 (object)

**체크리스트**:

- [ ] `read_file`로 파일 읽기
- [ ] 라인 수 확인
- [ ] 제목 포맷팅:
  - 파일명에서 `.md` 제거
  - `_` → 공백 변환
  - 연속 공백 제거
- [ ] 청크 전략 결정:
  - < 500줄: 1개 청크
  - 500-2,000줄: 200-300줄 단위
  - > 2,000줄: 300-500줄 단위

**사용자 전달**: `"📄 파일 읽기 완료: [파일명].md ([라인수]줄), 제목: [포맷팅된 제목]"`

#### 3.2 페이지 생성 전략 {#페이지-생성-전략}

**Conditional Logic (우선순위)**:

```
IF 부모 페이지 ID 없음:
  → API로 페이지 생성 (워크스페이스 루트)
  → 내용 업로드 진행

ELSE IF 부모 페이지 ID 있음:
  ❶ API 시도 (페이지 생성 → 부모로 이동)
  
  ❷ 🚨 API 성공 여부 확인 (필수):
     성공: 내용 업로드 진행
     실패: 다음 단계로
     
  ❸ API 실패 감지 시:
     ⚠️ 절대 전역에 생성된 페이지 사용 금지!
     ⚠️ 즉시 브라우저 자동화(PlayWright)로 전환
     → 부모 페이지 URL 접속
     → 🔍 편집 권한 확인 (필수!)
     → 권한 있음: 하위 페이지 생성 진행
     → 권한 없음: ERR_BROWSER_NO_EDIT_PERMISSION 에러 보고
     → 하위 페이지 생성 (UI 버튼 또는 Ctrl+Shift+P 사용)
     → ⚠️ /page 명령어는 동작이 불안정하므로 사용하지 않음!
     → 🔍 페이지 생성 성공 확인 (필수!)
     → 생성 실패: ERR_PAGE_CREATION_FAILED 에러 보고
     → 생성 성공: 다음 단계 진행
     → 제목 입력
     → 🔍 제목 입력 검증 (필수!)
     → 내용 영역으로 안전하게 이동
     → 🔍 내용 영역 확인 (필수!)
     → 내용 업로드 (각 청크별 검증 포함)
```

**🚨 중요**: 
- 부모 페이지 지정 시 API 실패하면, **그냥 전역에 만들고 끝내지 마세요**
- 반드시 브라우저 자동화로 재시도
- **편집 권한 확인**은 필수 단계 (공유 페이지는 권한 제한될 수 있음)
- **페이지 생성 검증**은 필수 단계 (생성 안 되고 계속 진행하면 모든 작업 실패)
- **제목 입력 검증**은 필수 단계 (제목이 잘못되면 문서 품질 저하)
- **각 청크별 검증**은 필수 단계 (순서 섞임 및 제목 변경 방지)

#### 3.3 내용 업로드 {#내용-업로드}

**Input**: 파일 내용 (string), 청크 전략 (object)  
**Output**: 업로드 완료 여부 (boolean)

**체크리스트**:

- [ ] 파일을 청크로 분할 (최대 2,000자/청크)
- [ ] **각 청크 업로드 시 검증** (품질 보장):
  - [ ] **입력 전 검증**: 제목 영역에 있지 않은지 확인
  - [ ] 각 청크를 클립보드에 복사
  - [ ] 페이지 하단으로 스크롤
  - [ ] 편집 영역 포커스
  - [ ] Ctrl+V로 붙여넣기
  - [ ] **입력 후 검증 1**: 제목이 변경되지 않았는지 확인
  - [ ] **입력 후 검증 2**: 이전 청크와 연결되는지 확인 (2번째 청크부터)
  - [ ] 각 청크 사이 1-2초 대기
  - [ ] 진행률 보고: `"📤 청크 [N]/[전체] 업로드 중... (진행률: [%])"`

**🔍 품질 검증 세부사항**:

1. **입력 전 검증** (매 청크):
   ```javascript
   - 제목 영역에 포커스되어 있지 않은지 확인
   - 제목이 예상 제목과 일치하는지 확인
   - 실패 시 즉시 중단
   ```

2. **입력 후 검증 - 제목 보호** (매 청크):
   ```javascript
   - 제목이 변경되지 않았는지 확인
   - 제목에 내용이 섞이지 않았는지 확인
   - 실패 시 즉시 중단 및 복구
   ```

3. **입력 후 검증 - 연결성** (2번째 청크부터):
   ```javascript
   - 이전 청크의 마지막 50자 확인
   - 현재 청크의 첫 50자 확인
   - 페이지 본문에서 순서가 올바른지 확인
   - 실패 시 즉시 중단 (순서 섞임 감지)
   ```

**참조**: `02_코드_패턴.md`의 검증 함수 패턴 참조

#### 3.4 검증 및 완료 보고 {#완료-보고}

**Input**: 파일의 마지막 줄 텍스트 (string)  
**Output**: 검증 결과, 페이지 URL (object)

**체크리스트**:

- [ ] 파일의 마지막 줄 텍스트 확인
- [ ] Notion 페이지에서 해당 텍스트 검색
- [ ] 검증 성공 시 페이지 URL 반환

---

## 🔧 파일 경로 처리

**처리 우선순위**:

1. **절대 경로** (명시된 경우)

   - 예: `e:\INFAC_WEB\...\에러.md`
   - 그대로 사용

2. **상대 경로** (워크스페이스 기준)

   - 예: `에러.md`, `./에러.md`, `docs/API.md`
   - 워크스페이스 루트 기준으로 해석

3. **파일명만** (워크스페이스 전체 검색)
   - 예: `에러.md`
   - 워크스페이스 전체에서 파일 검색 (`glob_file_search` 사용)

---

## 🔗 부모 페이지 URL 파싱

**지원하는 URL 형식**:

1. **일반 URL**: `https://www.notion.so/2939168184838094b94bc4ad6aab8c88`
2. **공유 페이지 URL**: `https://purple-paint-fa5.notion.site/2939168184838094b94bc4ad6aab8c88`
3. **앵커 포함 URL**: `https://www.notion.so/...#2e691681848380dea12dc5443e3c3931`
4. **UUID 형식**: `2939168184838094b94bc4ad6aab8c88` 또는 `29391681-8483-8094-b94b-c4ad6aab8c88`

---

## 🛡️ 기존 페이지 내용 보존 규칙

**⚠️ 절대 규칙**:

1. **기존 페이지의 내용을 절대 삭제하지 않음**

   - 제목 영역에 기존 텍스트가 있으면 삭제하지 않음
   - 본문 영역에 기존 내용이 있으면 보존하고 하단에만 추가

2. **새 페이지 vs 기존 페이지 구분**

   - 새 페이지 생성 시: 제목이 "새 페이지" 또는 "Untitled"인 경우에만 제목 입력
   - 기존 페이지 수정 시: 제목 입력 전 기존 내용 확인 및 보존

3. **내용 추가 시 기존 내용 확인**
   - 기존 내용이 있는지 확인
   - 기존 내용이 있으면 하단에만 추가

---

## 📊 데이터 규격 (Schema)

### Input Schema

```typescript
interface NotionUploadRequest {
  // 필수
  filePath: string; // 파일 경로 (예: "README.md")

  // 선택적
  parentPageId?: string; // 부모 페이지 ID (UUID 형식)
  customTitle?: string; // 사용자 지정 제목
  action?: "create" | "append"; // 기본값: "create"
}
```

### Output Schema

```typescript
interface NotionUploadResult {
  success: boolean;
  pageId?: string; // 생성된 페이지 ID
  pageUrl?: string; // 생성된 페이지 URL
  title?: string; // 사용된 페이지 제목
  chunkCount?: number; // 업로드된 청크 수
  error?: string; // 에러 메시지 (실패 시)
}
```

---

## 📝 제목 포맷팅

**규칙**:

1. 파일명에서 `.md` 확장자 제거
2. `_` → 공백 변환
3. 연속 공백 → 단일 공백
4. 앞뒤 공백 제거

**예시**:

- `README.md` → `README`
- `노션_셋업_가이드.md` → `노션 셋업 가이드`
- `프로젝트_코드_분석_보고서.md` → `프로젝트 코드 분석 보고서`

---

## 📏 청크 전략

| 파일 크기   | 청크 단위       | 예시      |
| ----------- | --------------- | --------- |
| < 500줄     | 1개 청크 (전체) | 작은 문서 |
| 500-2,000줄 | 200-300줄 단위  | 중간 문서 |
| > 2,000줄   | 300-500줄 단위  | 큰 문서   |

**제한**: 각 청크는 최대 2,000자

---

## ⚠️ 핵심 규칙

1. **🚨 부모 페이지 지정 시 API 실패하면 절대 전역에 생성 금지**

   - ❌ 잘못: API 실패 → 전역에 생성하고 완료 보고
   - ✅ 올바름: API 실패 → 즉시 브라우저 자동화로 전환
   - 생성된 페이지는 무시 (사용자가 나중에 정리)
   - 부모 페이지 내에서 반드시 새로 생성

2. **API 실패 시 즉시 브라우저 자동화로 전환**

   - 실패 감지: 권한 에러, 이동 실패, 타임아웃
   - 자동 fallback: 다른 방법으로 재시도
   - 사용자에게 전환 과정 보고

3. **모든 단계에서 사용자에게 진행 상황 보고**

   - 각 단계 시작/완료 시 알림
   - 청크 업로드 진행률 표시
   - API 실패 시 fallback 전환 알림

4. **에러 발생 시 즉시 중단 및 보고**

   - 에러 보고 형식: `03_에러_처리.md` 참조

5. **⚠️ 기존 페이지 내용 보존 (절대 규칙)**
   - 기존 페이지의 내용을 절대 삭제하거나 수정하지 않음
   - 새 페이지 생성 시에만 제목 입력 및 내용 추가
   - 기존 페이지에 내용 추가 시 기존 내용 확인 및 보존

---

## 📚 상세 가이드 참조

- **실행 절차**: `01_실행_가이드.md`
- **코드 패턴**: `02_코드_패턴.md`
- **에러 처리**: `03_에러_처리.md`
- **템플릿**: `04_템플릿.md`

---

## 🌐 플랫폼별 설정

각 플랫폼의 구체적인 설정은 다음을 참조하세요:

- **Cursor**: `../Platform_Guides/Cursor/설정_가이드.md`
- **Claude**: `../Platform_Guides/Claude/설정_가이드.md`
- **Antigravity**: `../Platform_Guides/Antigravity/설정_가이드.md`

---

**Made with ❤️ for AI Agents (Universal)**

---

## 📝 출처

**작성자**: 김준모  
**이메일**: rnsdlsdmtlk@gmail.com  
**버전**: 2.0.0 (Universal)
