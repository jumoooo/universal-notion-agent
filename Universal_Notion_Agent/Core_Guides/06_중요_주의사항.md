# ⚠️ 중요 주의사항 (AI Agent용)

> **자주 발생하는 실수와 주의사항**

## 🚨 절대 하지 말아야 할 것

### 0. ⚠️ 공유 페이지 편집 권한 확인 필수

**상황**: 사용자가 공유 페이지 URL을 부모 페이지로 지정

**권한 확인 방법**:

```javascript
// contenteditable 영역 및 하위 페이지 추가 버튼 확인
const editableAreas = document.querySelectorAll('[contenteditable="true"]');
const addPageButton = document.querySelector('[aria-label*="Add a page"]');

if (editableAreas.length === 0 || !addPageButton) {
  // 권한 없음 - 에러 보고 필수!
  return ERR_BROWSER_NO_EDIT_PERMISSION;
}
```

**잘못된 동작**:

```
1. 부모 페이지 접속
2. 권한 확인 생략  ← ❌ 잘못됨!
3. /page 입력 시도 → 작동 안 함
4. 버튼 클릭 시도 → 차단됨
5. 계속 시도... (무한 루프)
```

**올바른 동작**:

```
1. 부모 페이지 접속
2. 🔍 편집 권한 확인 (필수!)  ← ✅ 올바름!
3. 권한 없음 감지
4. ERR_BROWSER_NO_EDIT_PERMISSION 에러 보고
5. 사용자에게 권한 요청 또는 다른 방법 제시
```

**이유**:

- 공유 페이지는 편집 권한이 제한될 수 있음
- 권한 없이 강제로 진행하면 모든 방법이 실패함
- 사용자에게 명확한 안내가 필요함

---

### 1. ❌ 부모 페이지 지정 시 전역 생성 금지

**상황**: 사용자가 부모 페이지를 지정했는데 API 이동 실패

**잘못된 동작**:

```
1. API로 페이지 생성 (워크스페이스 루트에 생성됨)
2. 부모 페이지로 이동 시도
3. 이동 실패 ❌
4. "페이지가 생성되었습니다!" 완료 보고  ← ❌ 잘못됨!
```

**올바른 동작**:

```
1. API로 페이지 생성 (워크스페이스 루트에 생성됨)
2. 부모 페이지로 이동 시도
3. 이동 실패 감지 🚨
4. "API 실패 감지, 브라우저 자동화로 전환합니다" 보고
5. 생성된 페이지 무시
6. 브라우저 자동화(PlayWright)로 전환
7. 부모 페이지 접속 → /page → 하위 페이지 생성
8. 내용 업로드 → 완료 보고  ← ✅ 올바름!
```

**이유**:

- 사용자가 부모 페이지를 지정한 이유: **그 위치에 만들고 싶어서**
- 전역에 만들면: 사용자가 원한 위치가 아님
- **실패를 감지하고 다른 방법으로 재시도하는 것이 PlayWright를 쓰는 이유**

---

### 2. ❌ 제목에 명령어 포함 금지

**잘못된 예**:

```
페이지 제목: "/page 노션 셋업 가이드"  ← ❌ 잘못됨!
페이지 제목: "Ctrl+Shift+P 가이드"    ← ❌ 잘못됨!
```

**올바른 예**:

```
1. 하위 페이지 생성 (UI 버튼 또는 Ctrl+Shift+P)
2. 새 페이지 생성됨
3. 제목 영역에 "노션 셋업 가이드"만 입력  ← ✅ 올바름!
```

**⚠️ 중요**: `/page` 명령어는 불안정합니다!

- `/page`는 **페이지 mention**을 생성하거나 동작이 일관적이지 않음
- **권장 방법**: UI 버튼 사용 또는 `Ctrl+Shift+P` (Windows) / `Cmd+Shift+P` (Mac)
- 제목은 새로 생성된 페이지의 **제목 영역**에만 순수 텍스트로 입력

---

### 3. ❌ 기존 내용 삭제 금지

**절대 규칙**:

- 기존 페이지 내용을 절대 삭제하지 않음
- 기존 내용이 있으면 **하단에만 추가**
- 제목이 이미 있으면 제목 변경하지 않음

---

### 4. ❌ 청크를 너무 크게 나누지 않기

**잘못된 예**:

```
청크 크기: 5,000줄  ← ❌ 너무 큼!
```

**올바른 예**:

```
청크 크기: 200-500줄  ← ✅ 적당함
```

---

## ✅ 반드시 해야 할 것

### 0. ✅ 품질 보장: 각 단계별 검증 필수

**목적**: 문서 품질 보장 및 순서 섞임 방지

#### 검증 타이밍

```
페이지 생성
   ↓
제목 입력
   ↓
✅ 제목 검증 (필수!)  ← 제목이 정확한지 확인
   ↓
내용 영역 이동
   ↓
✅ 영역 확인 (필수!)  ← 제목 영역에서 벗어났는지 확인
   ↓
━━━━━ 청크 업로드 루프 시작 ━━━━━
   ↓
✅ 입력 전 검증 (필수!)  ← 제목 영역 아닌지 확인
   ↓
청크 1 입력
   ↓
✅ 입력 후 검증 (필수!)  ← 제목 변경 확인
   ↓
✅ 입력 전 검증 (필수!)  ← 제목 영역 아닌지 확인
   ↓
청크 2 입력
   ↓
✅ 입력 후 검증 (필수!)  ← 제목 변경 + 연결성 확인
   ↓
...
━━━━━ 청크 업로드 루프 종료 ━━━━━
   ↓
최종 검증
```

#### 검증 항목

**1. 제목 입력 후 검증**:
```javascript
const titleCheck = await browser_evaluate((expected) => {
  const actual = document.querySelector('h1[contenteditable="true"]')?.innerText.trim();
  return {
    success: actual === expected,
    expected: expected,
    actual: actual
  };
}, expectedTitle);

if (!titleCheck.success) {
  throw new Error("제목 입력 실패");
}
```

**2. 내용 영역 이동 확인**:
```javascript
const areaCheck = await browser_evaluate(() => {
  const titleElement = document.querySelector('h1[contenteditable="true"]');
  const isFocusedOnTitle = titleElement?.contains(document.activeElement);
  
  return {
    success: !isFocusedOnTitle,
    message: isFocusedOnTitle ? "제목 영역에 있음" : "내용 영역에 있음"
  };
});

if (!areaCheck.success) {
  throw new Error("내용 영역 이동 실패");
}
```

**3. 청크 입력 전 검증** (매 청크마다):
```javascript
// 제목 영역에 있지 않은지 확인
const preCheck = await browser_evaluate((expected) => {
  const titleElement = document.querySelector('h1[contenteditable="true"]');
  const isFocusedOnTitle = titleElement?.contains(document.activeElement);
  const currentTitle = titleElement?.innerText.trim();
  
  return {
    success: !isFocusedOnTitle && currentTitle === expected,
    isFocusedOnTitle: isFocusedOnTitle,
    titleChanged: currentTitle !== expected
  };
}, expectedTitle);

if (!preCheck.success) {
  throw new Error("입력 전 검증 실패");
}
```

**4. 청크 입력 후 검증** (매 청크마다):
```javascript
// A. 제목 변경 확인
const titleCheck = await browser_evaluate((expected) => {
  const actual = document.querySelector('h1[contenteditable="true"]')?.innerText.trim();
  return {
    success: actual === expected,
    expected: expected,
    actual: actual
  };
}, expectedTitle);

if (!titleCheck.success) {
  throw new Error("제목이 변경됨");
}

// B. 연결성 확인 (2번째 청크부터)
if (chunkIndex > 0) {
  const prevEnd = chunks[chunkIndex - 1].slice(-50);
  const currStart = chunks[chunkIndex].slice(0, 50);
  
  const continuityCheck = await browser_evaluate((prev, curr) => {
    const bodyText = document.body.innerText;
    const prevIndex = bodyText.indexOf(prev);
    const currIndex = bodyText.indexOf(curr);
    
    return {
      success: prevIndex !== -1 && currIndex !== -1 && prevIndex < currIndex,
      prevIndex: prevIndex,
      currIndex: currIndex,
      hasPrev: prevIndex !== -1,
      hasCurr: currIndex !== -1,
      correctOrder: prevIndex < currIndex
    };
  }, prevEnd, currStart);
  
  if (!continuityCheck.success) {
    throw new Error("청크 순서 또는 연결성 실패");
  }
}
```

**왜 이렇게 해야 하나요?**

❌ **검증 없이 진행할 때**:
```
1. 제목 입력
2. 바로 내용 입력 시작
3. ❌ 실수로 제목 영역 건드림
4. 제목과 내용이 섞임
5. 청크 순서가 바뀜
6. 나중에 발견 → 복구 어려움
```

✅ **검증하면서 진행할 때**:
```
1. 제목 입력
2. ✅ 제목 검증 → 정확함 확인
3. 내용 영역 이동
4. ✅ 영역 확인 → 제목 영역 벗어남 확인
5. 청크 1 입력
6. ✅ 제목 확인 → 변경 안 됨 확인
7. 청크 2 입력
8. ✅ 제목 확인 + 연결성 확인 → 순서 올바름 확인
9. 문제 조기 발견 → 즉시 복구 가능
```

---

### 1. ✅ 단계 구분 명확히

**하위 페이지 생성 과정**:

```
단계 1: 부모 페이지 접속
   ↓
단계 2: 하위 페이지 생성 (권장 방법 선택)
   방법 A: UI 메뉴 버튼 (... → "페이지 추가")
   방법 B: 키보드 단축키 Ctrl+Shift+P
   ⚠️ /page 명령어는 동작이 불안정함
   ↓
단계 3: 새 페이지 로딩 대기 (1-2초)
   ↓
단계 4: 제목 영역 찾기 (h1[contenteditable="true"])
   ↓
단계 5: 제목만 입력  ← "노션 셋업 가이드" (명령어 없음!)
   ↓
단계 6: 내용 영역으로 이동
   ↓
단계 7: 마크다운 내용 붙여넣기 (최하단에)
```

---

### 2. ✅ 영역 구분

**Notion 페이지 구조**:

```
┌─────────────────────────────┐
│ [제목 영역]                  │  ← 여기에 제목만 입력
│ h1[contenteditable="true"]   │
├─────────────────────────────┤
│                             │
│ [내용 영역]                  │  ← 여기에 마크다운 붙여넣기
│ [contenteditable="true"]     │
│                             │
│ (기존 내용이 있으면 보존)     │
│                             │
│ [최하단]  ← 여기에 추가      │
│ [빈 줄]  ← /page 입력할 곳   │
└─────────────────────────────┘
```

---

### 3. ✅ 페이지 생성 방법과 입력 구분

| 동작                | 방법                               | 비고                         |
| ------------------- | ---------------------------------- | ---------------------------- |
| 하위 페이지 생성    | UI 버튼 또는 `Ctrl+Shift+P`        | 권장 (안정적)                |
| ~~하위 페이지 생성~~| ~~`/page` 명령어~~                 | 비권장 (동작 불안정)         |
| 제목 입력           | 제목 영역에 `노션 셋업 가이드`     | 순수 텍스트만                |
| 내용 입력           | 내용 영역에 마크다운 내용          | 페이지 본문                  |

---

## 🔍 자주 발생하는 실수

### 실수 0: 페이지 생성 검증 생략

**문제**: 페이지가 실제로 생성되지 않았는데 다음 단계로 진행

```javascript
// 잘못된 코드 - 검증 없이 진행
await browser_type({ text: "/page\n" });
await browser_wait_for({ time: 2 });
// 생성 확인 없이 바로 제목 입력 시도  ← ❌ 잘못됨!
await browser_type({ text: "제목" });
```

**실패 신호들**:
- ❌ `/page` 텍스트가 그대로 남아있음
- ❌ URL이 변경되지 않음
- ❌ 제목 영역이 없음
- ❌ 대화상자가 열림

**해결**:

```javascript
// 올바른 코드 - 반드시 검증
await browser_type({ text: "/page\n" });
await browser_wait_for({ time: 2 });

// 1. 페이지 생성 검증 (필수!)
const result = await browser_evaluate(() => {
  const titleElement = document.querySelector('h1[contenteditable="true"]');
  const hasPageCommand = document.body.innerText.includes('/page');
  const titleText = titleElement?.innerText.trim();
  
  // 실패 조건 확인
  if (hasPageCommand || !titleElement) {
    return {
      success: false,
      error: "페이지 생성 실패",
      hasPageCommand: hasPageCommand,
      hasTitleElement: !!titleElement
    };
  }
  
  return { success: true };
});

// 2. 실패 시 즉시 중단
if (!result.success) {
  throw new Error("ERR_PAGE_CREATION_FAILED");
}

// 3. 성공 시에만 제목 입력
await browser_type({ text: "제목" }); // ✅ 올바름!
```

---

### 실수 1: 잘못된 페이지 생성 방법

**문제**:

```javascript
// 잘못된 코드 - /page 명령어 사용 (불안정)
await browser_type({ text: "/page\n" }); // ❌ 동작 불안정
await browser_wait_for({ time: 2 });

// 또는 명령어를 제목에 포함
const title = "/page " + formatPageTitle(fileName); // ❌ 더 잘못됨!
```

**해결**:

```javascript
// 올바른 코드 - UI 버튼 또는 키보드 단축키 사용
// 방법 A: UI 버튼 사용 (가장 안정적)
await browser_evaluate(() => {
  const menuButton = document.querySelector('[aria-label*="메뉴"]');
  menuButton?.click();
});
await browser_wait_for({ time: 500 });

// 메뉴에서 "페이지 추가" 클릭
await browser_click({ element: "페이지 추가", ref: "..." });
await browser_wait_for({ time: 2000 }); // 새 페이지 로딩

// 방법 B: 키보드 단축키 (대체 방법)
await browser_press_key({ key: "Control+Shift+KeyP" }); // Windows
await browser_wait_for({ time: 2000 });

// 2. 그 다음 제목만 입력 (제목 영역에)
const title = formatPageTitle(fileName); // ✅
await browser_type({ element: "제목", ref: "...", text: title });
```

---

### 실수 2: 영역 혼동

**문제**: 제목을 내용 영역에 쓰거나, 내용을 제목 영역에 씀

**해결**:

```javascript
// 1. 제목 영역 찾기
const titleElement = document.querySelector('h1[contenteditable="true"]');

// 2. 내용 영역 찾기
const contentElements = document.querySelectorAll('[contenteditable="true"]');
const contentArea = contentElements[contentElements.length - 1];
```

---

### 실수 3: 기존 내용 위치 무시

**문제**: 기존 내용이 있는데 중간에 삽입

**해결**:

```javascript
// 1. 기존 내용 확인
const hasContent = contentArea.innerText.trim().length > 0;

if (hasContent) {
  // 2. 최하단으로 스크롤
  contentArea.scrollIntoView({ block: "end" });

  // 3. 최하단에 포커스
  const range = document.createRange();
  range.selectNodeContents(contentArea);
  range.collapse(false); // 끝으로
}
```

---

## 📋 체크리스트

### 페이지 생성 시

- [ ] 빈 줄에 `/page` 입력 (명령어)
- [ ] 새 페이지 로딩 대기
- [ ] 제목 영역 찾기 (`h1[contenteditable="true"]`)
- [ ] 제목만 입력 (명령어 없음)
- [ ] ❌ 제목에 `/page` 포함하지 않음

### 내용 업로드 시

- [ ] 내용 영역 찾기
- [ ] 기존 내용 확인
- [ ] 기존 내용이 있으면 최하단으로 스크롤
- [ ] 최하단에만 추가
- [ ] ❌ 기존 내용 삭제하지 않음

---

## 🎯 핵심 원칙

### 원칙 1: 명령어 ≠ 제목

```
/page  ← 명령어 (페이지 생성용)
≠
노션 셋업 가이드  ← 제목 (페이지 이름)
```

### 원칙 2: 영역 분리

```
제목 영역: 제목만
내용 영역: 마크다운 내용만
빈 줄: 명령어만
```

### 원칙 3: 기존 내용 보존

```
기존 내용 위치: 보존
새 내용 위치: 최하단에만 추가
```

---

**이 가이드를 항상 참조하세요!** ⚠️

**Universal Notion Agent v2.1.1**
